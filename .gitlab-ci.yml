stages:
  - build-base-image
  - test-parsing-and-injection
  - test-components
  - test-singularity
  - test-docker
  - deploy

variables:
  GIT_DEPTH: "3"


############################################################
#####              BUILD IMAGES                        #####
############################################################

# Build the base image which is used to test installation and build the final hep-benchmark-suite image
.definition_build_image: &template_build_image
  image: # NB enable shared runners and do not specify a CI tag
    name: gitlab-registry.cern.ch/ci-tools/docker-image-builder # CERN version of the Kaniko image
    entrypoint: [""]
  script:
    # Prepare Kaniko configuration file
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    # Build and push the image from the Dockerfile at the root of the project.
    # To push to a specific docker tag, amend the --destination parameter, e.g. --destination $CI_REGISTRY_IMAGE:$CI_BUILD_REF_NAME
    # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
    - /kaniko/executor --context $CONTEXT --dockerfile $DOCKERFILE $DESTINATIONS 

job_build_logstash_image:
    stage: build-base-image
    before_script:
        - export DOCKERFILE=$CI_PROJECT_DIR/docker-images/logstash/Dockerfile
        - export CONTEXT=$CI_PROJECT_DIR/
        - export DESTINATIONS="--destination $CI_REGISTRY_IMAGE/logstash:${CI_COMMIT_BRANCH} --destination $CI_REGISTRY_IMAGE/logstash:${CI_COMMIT_SHA:0:8}"
    <<: *template_build_image
    only:
        variables:
        - $CI_COMMIT_BRANCH =~ /^qa-.*$/
        - $CI_COMMIT_BRANCH =~ /^qa$/
        changes:
          - docker-images/logstash/*

job_build_elasticsearch_image:
  stage: build-base-image
  before_script:
      - export DOCKERFILE=$CI_PROJECT_DIR/docker-images/es-extractor/Dockerfile
      - export CONTEXT=$CI_PROJECT_DIR/docker-images/es-extractor
      - export DESTINATIONS="--destination $CI_REGISTRY_IMAGE/es-extractor:${CI_COMMIT_BRANCH} --destination $CI_REGISTRY_IMAGE/es-extractor:${CI_COMMIT_SHA:0:8} --destination $CI_REGISTRY_IMAGE/es-extractor:latest"
  <<: *template_build_image
  only:
      variables:
        - $CI_COMMIT_BRANCH =~ /^qa-.*$/
        - $CI_COMMIT_BRANCH =~ /^qa$/
      changes:
        - docker-images/es-extractor/*


############################################################
#####              TEST COMPONENTS                     #####
############################################################

test_python_support:
  # determine minimum supported python version
  stage: test-components
  dependencies: []
  script:
    - yum install -y -q python3-pip
    - python3 -m pip install -U pip vermin
    - vermin -vv .
  only:
    changes:
      - "*.py"
      - bin/*

test_python_coverage:
  stage: test-components
  dependencies: []
  script:
    - yum install -y -q python3-pip
    - python3 -m pip install -U pip tox
    - tox
  except:
    refs:
      - master
      - qa
  artifacts:
    reports:
      junit: report.xml
    paths:
      - htmlcov/*
    expire_in: 1 week
    when: always

test_python_pep8:
  stage: test-components
  dependencies: []
  allow_failure: true
  script:
    - yum install -y -q python3-pip
    - python3 -m pip install -U pip tox
    - tox -e pep8
  except:
    refs:
      - master
      - qa

test_python_security:
  stage: test-components
  dependencies: []
  allow_failure: true
  script:
    - yum install -y -q python3-pip
    - python3 -m pip install -U pip tox
    - tox -e bandit
  except:
    refs:
      - master
      - qa

test_yaml_files:
  stage: test-components
  dependencies: []
  script:
    - yum install -y -q yamllint
    - cd hepbenchmarksuite/config
    - yamllint benchmarks.yml
  only:
    changes:
      - "*.yaml"
      - "*.yml"
  except:
    refs:
      - master
      - qa

test_db12_benchmark:
  stage: test-components
  dependencies: []
  script:
    - yum install -y -q singularity python3-pip
    - python3 -m pip install --user --upgrade pip
    - python3 -m pip install --user .
    - export PATH=~/.local/bin:$PATH
    - bmkrun --rundir . --benchmarks db12
  artifacts:
    paths:
      - result_profile.json
      - run_config.yaml
    expire_in: 1 week
    when: always
  except:
    refs:
      - master
      - qa

test_config_missmatch:
  stage: test-components
  script:
    - yum install -y -q curl
    - curl -o hepscore_cfg https://gitlab.cern.ch/hep-benchmarks/hep-score/-/raw/v1.0rc5/hepscore/etc/hepscore20_0.2.yaml
    - grep -A1000 hepscore_benchmark $CI_PROJECT_DIR/hepbenchmarksuite/config/benchmarks.yml > suite_cfg_hepscore
    - diff hepscore_cfg suite_cfg_hepscore

############################################################
#####              TEST PARSING & INJECTION            #####
############################################################


bats_test_docker_dompose_qa:
  stage: test-parsing-and-injection
  image: 
    name: gitlab-registry.cern.ch/cloud-infrastructure/data-analytics/compose:v0.1
    entrypoint: [""]
  tags:
    -  hep-benchmark-suite-docker-runner
  only:
    variables:
      - $CI_COMMIT_BRANCH =~ /^qa.*$/
  before_script:
    - . $CI_PROJECT_DIR/tests/docker_compose_amq_to_es/ci_run_script.sh
    - start_docker_compose
  script:
    - run_amq_bats_test
    - sleep 10
    - run_reader
  after_script:
    - . $CI_PROJECT_DIR/tests/docker_compose_amq_to_es/ci_run_script.sh
    - stop_docker_compose
  artifacts:
    paths:
        - $CI_PROJECT_DIR/tests/docker_compose_amq_to_es/*
    expire_in: 1 week
    when: always

############################################################
#####              TEST SINGULARITY                    #####
############################################################

.test_qa_singularity:
    # This job tests the hep-benchmark-suite
    # running a configurable set of benchmarks defined in $BMKLIST
  stage: test-singularity
  dependencies: []
  tags: 
    - docker-privileged-xl
    #- hep-benchmark-suite-docker-runner
  # use image that has singularity.cern repo
  image: gitlab-registry.cern.ch/linuxsupport/cc7-base
  script:
    - yum install -y -q git singularity python3-pip
    # non-root user
    - useradd -d $(pwd) -g users -M -N unprivUser
    - chown -R unprivUser:users ..
    - su - unprivUser
    - set -e
    # install the benchmark suite python package
    - python3 -m pip install --user --upgrade pip
    - python3 -m pip install --user .
    - export PATH=$PATH:~/.local/bin
    #- export AMQ_ARGUMENTS="--queue_host=$QUEUE_HOST --queue_port=$QUEUE_PORT --username=$QUEUE_USERNAME --password=$QUEUE_PASSWD --topic=$QUEUE_TOPIC"
    - export BMK_VOLUME=/tmp/${CI_JOB_NAME}_${CI_JOB_ID}
    - export RESULTS_FILE=$CI_JOB_NAME.json
    # if .sif was already built, then use it!
    - if [ -d singularity_cachedir ]; then mkdir -p $BMK_VOLUME/singularity_cachedir; mv singularity_cachedir/ $BMK_VOLUME/; fi
    # run $BMKLIST as singularity
    - bmkrun --mode=singularity --config=tests/benchmarks_ci_test.yml --rundir=$BMK_VOLUME --benchmarks=$BMKLIST --file=$RESULTS_FILE
    - mv $BMK_VOLUME/run_*/$RESULTS_FILE $CI_PROJECT_DIR
    - mv $BMK_VOLUME/singularity_cachedir $CI_PROJECT_DIR
  only:
    variables:
      - $CI_COMMIT_BRANCH =~ /^qa-.*$/
      - $CI_COMMIT_BRANCH =~ /^qa$/
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    paths:
      - singularity_cachedir/cache/**/*
  artifacts:
    untracked: true
    paths:
      - ./*.json
    exclude:
      - singularity_cachedir
    expire_in: 1 week
    when: always

test_sing_hepscore:
  extends: .test_qa_singularity
  before_script:
    - export BMKLIST="hepscore"
test_sing_hs06:
  extends: .test_qa_singularity
  before_script:
    - export BMKLIST="hs06_32"
    - export HS06URL=$HS06URL
    - sed -ri "s|url_tarball:.*|url_tarball:\ \"$HS06URL\"|" tests/benchmarks_ci_test.yml

test_sing_spec2017:
  extends: .test_qa_singularity
  before_script:
    - export BMKLIST="spec2017"
    - export SPEC2017URL=$SPEC2017URL
    - sed -ri "s|url_tarball:.*|url_tarball:\ \"$SPEC2017URL\"|" tests/benchmarks_ci_test.yml

############################################################
#####              TEST DOCKER                         #####
############################################################

.test_qa_docker:
    # This job tests the hep-benchmark-suite
    # running a configurable set of benchmarks defined in $BMKLIST
  extends: .test_qa_singularity
  stage: test-docker
  services:
    - docker:19.03.1-dind
  variables:
    # Disable TLS following https://about.gitlab.com/2019/07/31/docker-in-docker-with-docker-19-dot-03/
    # This will result in a warning that the docker-in-docker service may not have started successfully
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375/
  script:
    - yum install -y -q git python3-pip docker-client
    # non-root user
    #- useradd -d $(pwd) -g users -M -N unprivUser
    #- chown -R unprivUser:users ..
    #- usermod -aG docker unprivUser
    #- su - unprivUser
    #- set -e
    # install the benchmark suite python package
    - python3 -m pip install --user --upgrade pip
    - python3 -m pip install .
    - export PATH=$PATH:~/.local/bin
    #- export AMQ_ARGUMENTS="--queue_host=$QUEUE_HOST --queue_port=$QUEUE_PORT --username=$QUEUE_USERNAME --password=$QUEUE_PASSWD --topic=$QUEUE_TOPIC"
    - export BMK_VOLUME=/tmp/${CI_JOB_NAME}_${CI_JOB_ID}
    - export RESULTS_FILE=$CI_JOB_NAME.json
    # run $BMKLIST as docker
    - bmkrun --mode=docker --rundir=$BMK_VOLUME --benchmarks=$BMKLIST --file=$RESULTS_FILE
    - mv $BMK_VOLUME/run_*/$RESULTS_FILE .
    - rm -rf $BMK_VOLUME
  only:
    variables:
      - $CI_COMMIT_BRANCH =~ /^qa-.*$/
      - $CI_COMMIT_BRANCH =~ /^qa$/
      - $CI_COMMIT_BRANCH =~ /^v2.*/
  artifacts:
    paths:
      - ./*.json
    expire_in: 1 week
    when: always

test_docker_hs06:
  extends: .test_qa_docker
  before_script:
    - export BMKLIST="hs06_32"
    - export HS06URL=$HS06URL
    - sed -ri "s|url_tarball:.*|url_tarball:\ \"$HS06URL\"|" tests/benchmarks_ci_test.yml

test_docker_spec2017:
  extends: .test_qa_docker
  before_script:
    - export BMKLIST="spec2017"
    - export SPEC2017URL=$SPEC2017URL
    - sed -ri "s|url_tarball:.*|url_tarball:\ \"$SPEC2017URL\"|" tests/benchmarks_ci_test.yml

############################################################
#####           BUILD & PUBLISH PACKAGE                #####
############################################################

build_hep-benchmark-suite:
  stage: deploy
  dependencies: []
  when: manual
  environment:
    # production keyword for gitlab value tracking
    name: production
    url: https://staging.example.com
  script:
    - yum install -y -q python3-pip
    - python3 -m pip install --upgrade setuptools wheel pip
    - python3 setup.py sdist bdist_wheel
    # some package publish step here
  artifacts:
    paths:
      - dist/
  except:
    refs:
      - master
      - qa

job_build_wheels:
  # is this job needed? it performs the same step as bdist_wheel (above)
  stage: deploy
  dependencies: []
  when: manual
  environment:
    # production keyword for gitlab value tracking
    name: production
    url: https://staging.example.com
  script:
    - yum install -y -q git python3-pip
    - python3 -m pip install --user --upgrade setuptools wheel pip
    - python3 -m pip wheel -r requirements.txt --wheel-dir=whl .
    - tar -cvf package_wheels.tar whl/
  artifacts:
    paths:
      - package_wheels.tar
    expire_in: 1 week
    when: always
  except:
    refs:
      - master
      - qa
